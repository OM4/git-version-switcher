#!/usr/bin/env bash

VERBOSE_OUTPUT=false
DO_CHECKOUT=true
DO_UPDATE=false
REPOSITORIES=()
CWD=$PWD
NC="\033[0m"
YELLOW="\033[0;33m"
GREEN="\033[0;32m"
CYAN="\033[0;36m"

function usage_info() {
  echo "git version switcher: Checkout specific branch|commit|tag on targets"
  echo
  echo "Usage: $(basename "$0") [-h] [-u] [-r] [-v] <TARGET1> [TARGET2â€¦]"
  echo "   -h | --help          Display this help message"
  echo "   -u | --update        Update default remote (fetch)"
  echo "   -r | --report-only   Discard version switching, only report"
  echo "   -v | --verbose       Verbose output"
  echo "   TARGET               Path and branch|commit|tag separated by a colon (:)"
}

get_phpunit_version() {
  if [ -f "$CWD/vendor/bin/phpunit" ]; then
    PU=$("$CWD/vendor/bin/phpunit" --version | awk '{print $2}')
  elif command -v phpunit >/dev/null; then
    PU=$("phpunit" --version | awk '{print $2}')
  else
    PU="N/A"
  fi
  echo $PU
}

environment_info() {
  PHP_V=$(php -r "echo PHP_VERSION, \"\n\";")
  if php -i | grep -q "xdebug support"; then XD=enabled; else XD=disabled; fi
  PU=$(get_phpunit_version)
  echo -e "${GREEN}PHP: $YELLOW$PHP_V, ${GREEN}Xdebug: $YELLOW$XD, ${GREEN}PHPUnit: $YELLOW$PU$NC"
}

remove_uncommitted_composer_lock_file() {
  if [ -f "$DIR/composer.lock" ] && [ $(git status --porcelain composer.lock | wc -l) -ne "0" ]; then
    $VERBOSE_OUTPUT && echo "$DIR/composer.lock is not committed to git. Deleting."
    rm -f "$DIR/composer.lock"
  fi
}

if [ $# -lt 1 ]; then
  echo Arguments missing!
  usage_info
  exit 1
fi

while [ -n "$1" ]; do
  case "$1" in
  --verbose | -v)
    VERBOSE_OUTPUT=true
    ;;
  --update | -u)
    DO_UPDATE=true
    ;;
  --report-only | -r)
    DO_CHECKOUT=false
    ;;
  --help | -h)
    usage_info
    exit
    ;;
  *)
    REPOSITORIES+=("$1")
    ;;
  esac
  shift
done

for REPO in "${REPOSITORIES[@]}"; do
  # Split param
  REPO_PATH=$(echo "$REPO" | cut -f1 -d':')
  REPO_TARGET=$(echo "$REPO" | cut -f2 -d':')

  # Test path
  if [ ! -d "$REPO_PATH" ]; then
    echo "Target path ($REPO_PATH) not exists. Aborting"
    exit 1
  fi

  cd "$REPO_PATH" || exit 1

  # Update (fetch)
  if $DO_UPDATE; then
    $VERBOSE_OUTPUT && echo "Update from remote (fetch) for $(pwd)" || true
    git fetch --tags --force
  fi

  # Checkout
  if $DO_CHECKOUT; then
    # Checkout target
    git checkout --force --quiet "$REPO_TARGET"

    # Directories to look for a composer.json file in
    DIRS=("$REPO_PATH" "$REPO_PATH/plugins/woocommerce")
    for DIR in "${DIRS[@]}"; do
      if [ -f "$DIR/composer.json" ]; then
        $VERBOSE_OUTPUT && echo "composer.json exists at $DIR/composer.json"
        cd "$DIR" || exit 1

        # Clean up files and then install composer dependencies
        remove_uncommitted_composer_lock_file

        if [ -d "$DIR/plugins" ] && [ $(git status --porcelain | grep "plugins/" | wc -l) -ne "0" ]; then
          rm -rf "$DIR/plugins"
          $VERBOSE_OUTPUT && echo "$DIR/plugins from WC monorepo deleted."
        fi
        if [ -d "$DIR/vendor" ]; then
          $VERBOSE_OUTPUT && echo "$DIR/vendor exists"
          if [ $(git status --porcelain vendor | wc -l) -eq "0" ]; then
            $VERBOSE_OUTPUT && echo "$DIR/vendor is committed to git, so no composer install required. Skipping."
            break
          else
            rm -rf "$DIR/vendor"
            $VERBOSE_OUTPUT && echo "$DIR/vendor is not committed to git. Deleted."
          fi
        fi

        remove_uncommitted_composer_lock_file

        $VERBOSE_OUTPUT && echo "Install composer packages to $(pwd)" || true
        if composer install --no-suggest --no-dev --quiet; then
          $VERBOSE_OUTPUT && echo "Composer install completed."
        else
          $VERBOSE_OUTPUT && echo "Composer install failed. Retrying with --ignore-platform-reqs."
          composer install --no-suggest --no-dev --quiet --ignore-platform-reqs
        fi
      fi
    done

  fi

  # Report target
  REPO_HEAD=$(git describe --tags --always)
  echo -e "$CYAN$(pwd): $YELLOW$REPO_HEAD$NC "
done

if $VERBOSE_OUTPUT; then
  environment_info
fi
